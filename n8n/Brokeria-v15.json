{
  "name": "Brokeria-v15",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "waha",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -128,
        4832
      ],
      "id": "e13785cc-46d8-49db-ac71-e33de0b3441d",
      "name": "Webhook",
      "webhookId": "ecb2c459-0f4c-4201-9a1f-67e5c5927290"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "78415b90-064b-46f3-8a36-8489bd14f43a",
              "name": "event",
              "value": "={{ $json.body.event }}",
              "type": "string"
            },
            {
              "id": "6d70d6a1-58d7-416a-a388-7b2aeabd4b85",
              "name": "session",
              "value": "={{ $json.body.session }}",
              "type": "string"
            },
            {
              "id": "ff0bd58d-efa1-4e49-9c9c-602aed25a290",
              "name": "payload_id",
              "value": "={{ $json.body.payload.id }}",
              "type": "string"
            },
            {
              "id": "0c990094-4206-417a-be86-008c8156acf8",
              "name": "from",
              "value": "={{ $json.body.payload.from }}",
              "type": "string"
            },
            {
              "id": "d33eb4cc-078e-40b7-9c9c-8fbba1e2aa76",
              "name": "to",
              "value": "={{ $json.body.payload.to }}",
              "type": "string"
            },
            {
              "id": "457f7c13-bf6f-4171-80bc-75620cfda604",
              "name": "source",
              "value": "={{ $json.body.payload.source }}",
              "type": "string"
            },
            {
              "id": "8ce79aa1-5408-48c9-8226-9ac6f875df12",
              "name": "body",
              "value": "={{ $json.body.payload.body }}",
              "type": "string"
            },
            {
              "id": "3fc1bd24-4960-40a3-9a52-5e1fa4365813",
              "name": "hasMedia",
              "value": "={{ $json.body.payload.hasMedia }}",
              "type": "boolean"
            },
            {
              "id": "7437da46-cfce-4e5b-909a-5daf06dfd2ad",
              "name": "type",
              "value": "={{ $json.body.payload._data.type }}",
              "type": "string"
            },
            {
              "id": "f8f215f3-ba00-485e-be98-354baa181f28",
              "name": "name",
              "value": "={{ $json.body.payload._data.notifyName }}",
              "type": "string"
            },
            {
              "id": "6508b08d-4b94-4352-8a94-c55ffd11cc91",
              "name": "fromMe",
              "value": "={{ $json.body.payload.fromMe }}",
              "type": "boolean"
            },
            {
              "id": "3ada40ac-45a0-440a-9e4b-44417caadf9c",
              "name": "to",
              "value": "={{ $json.body.payload.to }}",
              "type": "string"
            },
            {
              "id": "0096fa37-d92b-43ca-8c98-269cc5e1899f",
              "name": "id",
              "value": "={{ $json.body.id }}",
              "type": "string"
            },
            {
              "id": "30a509ba-e3aa-4e6a-b3ce-4f7d1fcbf46f",
              "name": "session_id",
              "value": "={{ $json.body.session + \u0027 \u0027 + $json.body.payload.from + \u0027 chats\u0027 }}",
              "type": "string"
            },
            {
              "id": "72d18f99-83a5-4bfb-8621-6af03d231409",
              "name": "user_text",
              "value": "={{ $json.body.payload.body }}",
              "type": "string"
            },
            {
              "id": "d1a86623-555b-4571-b71d-b7dc69e0b763",
              "name": "media_url",
              "value": "={{ $json.body.payload.media.url || $json.body.payload.url || \"\" }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        48,
        4832
      ],
      "id": "198ce6ce-92d4-4de0-9572-a8ffe503279f",
      "name": "Dados"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Seen",
        "session": "default",
        "chatId": "={{ $(\u0027DefinirContextoAI\u0027).first().json.contexto.telefone + \u0027@c.us\u0027 }}",
        "messageId": "",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [
        2512,
        5872
      ],
      "id": "14425c66-4428-4564-8869-9ae910b16e66",
      "name": "Send Seen",
      "alwaysOutputData": true,
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Start Typing",
        "session": "={{ $(\u0027Padronizar Output\u0027).first().json.target_session || \u0027default\u0027 }}",
        "chatId": "={{ $(\u0027Padronizar Output\u0027).first().json.target_chat_id }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [
        2656,
        5872
      ],
      "id": "69f232d6-706d-43d7-bf74-12befe7811c8",
      "name": "Start Typing",
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2800,
        5872
      ],
      "id": "993fa305-86a0-42d3-a595-e5847d31e844",
      "name": "Wait",
      "webhookId": "8322f7d9-15d2-4cb3-850f-7405eee27591"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $(\u0027Padronizar Output\u0027).first().json.target_session || \u0027default\u0027 }}",
        "chatId": "={{ $(\u0027Padronizar Output\u0027).first().json.target_chat_id }}",
        "reply_to": "=",
        "text": "={{ $json.text }}",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [
        3104,
        5872
      ],
      "id": "46bca101-83f0-4595-bb2c-d35a0047c3fa",
      "name": "Send a text message",
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ (\u0027http://waha:3000/api/\u0027 + $json.session + \u0027/lids/\u0027 + encodeURIComponent(($json.from || \u0027\u0027).trim())).trim() }}\n\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "accept",
              "value": "application/json"
            },
            {
              "name": "X-Api-Key",
              "value": "GR15VC0m5ueLygSMQPM6In4A8qfnrLT31ECnIEmZvnfyovsGxjUSfaFcMi1YQ3E1VvR9WjdJijFKGllhKAhkQ6yNYzYstzwtlQODhb06lknx3j8JlfxA7UCbzKCe61nbb"
            }
          ]
        },
        "options": {}
      },
      "id": "70585f50-5dcd-4584-bd1e-6bbf615f50e3",
      "name": "Consultar WAHA Direto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        208,
        4832
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "custom-field",
              "name": "PhoneNumber",
              "value": "={{ $json.pn ? $json.pn.split(\u0027@\u0027)[0] : undefined }}",
              "type": "string"
            },
            {
              "id": "835b86bc-37d1-4742-a421-3247982275a9",
              "name": "LidNumber",
              "value": "={{ $json.lid ? $json.lid.split(\u0027@\u0027)[0] : undefined }}",
              "type": "string"
            },
            {
              "id": "92fd4ba6-2d13-4ff9-b215-8895fd828fa2",
              "name": "isGroup",
              "value": "={{ ($json.pn || \u0027\u0027).endsWith(\u0027@g.us\u0027) }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "ff32b552-e64c-444b-87a1-830c8323327a",
      "name": "Limpar Telefone",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        368,
        4832
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "/* BANCO: brokeria_db | SCHEMA: public */\nSELECT \n  c.id_cliente, \n  c.nome_completo, \n  c.cpf, \n  c.email, \n  c.celular,\n  c.telefone,\n  (\n    SELECT json_agg(a)\n    FROM public.apolices_brokeria a\n    WHERE a.id_cliente::text = c.id_cliente::text  -- ðŸ’¡ Blindagem: forÃ§a comparaÃ§Ã£o entre textos\n  ) as apolices_detalhadas\nFROM public.clientes_brokeria c\nWHERE c.celular = \u0027{{ $node[\"Limpar Telefone\"].json.PhoneNumber }}\u0027\n   OR c.telefone = \u0027{{ $node[\"Limpar Telefone\"].json.PhoneNumber }}\u0027\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $(\u0027Limpar Telefone\u0027).item.json.PhoneNumber }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1200,
        5392
      ],
      "id": "5ebda921-841a-4a67-a6a3-88e275fb4c29",
      "name": "Busca_Cliente",
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const wait = (ms) =\u003e new Promise(resolve =\u003e setTimeout(resolve, ms));\nawait wait(Math.floor(Math.random() * 400)); \n\nlet mensagens = [];\nconst dadosEntrada = $input.first().json; \nconst msgId = dadosEntrada.payload_id; \nconst execId = $execution.id; // âœ… Captura ID exclusivo da execuÃ§Ã£o\n\ntry {\n  const redisItem = $(\"Recuperar_Buffer\").first();\n  if (redisItem \u0026\u0026 redisItem.json) {\n    const conteudoRedis = redisItem.json.Redis_Check_Buffer || redisItem.json.value;\n    if (conteudoRedis \u0026\u0026 typeof conteudoRedis === \u0027string\u0027) {\n      mensagens = JSON.parse(conteudoRedis);\n    }\n  }\n} catch (e) {\n  mensagens = [];\n}\n\nif (!mensagens.some(m =\u003e m.id === msgId)) {\n    mensagens.push({\n        id: msgId,\n        exec_id: execId, // âœ… Salva quem foi o Ãºltimo a escrever\n        texto: dadosEntrada.user_text || \"MIDIA_INPUT\", \n        tipo: dadosEntrada.mediaType || \"chat\"\n    });\n}\n\nreturn {\n    ...dadosEntrada, \n    texto_combinado: mensagens.map(m =\u003e m.texto).join(\u0027 \\n \u0027),\n    lista_raw: JSON.stringify(mensagens),\n    quantidade: mensagens.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16,
        5408
      ],
      "id": "473036e0-8c18-4343-a118-7994c613a59b",
      "name": "Agrupar_Texto"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=buffer:{{ $node[\"CheckOrigem\"].json.tecnico.session_id }}",
        "value": "={{ $json.lista_raw }}",
        "expire": true,
        "ttl": 10
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        160,
        5408
      ],
      "id": "a1a81ba9-fc73-4e3f-9483-1532cd0ee6fa",
      "name": "Atualizar_Buffer",
      "credentials": {
        "redis": {
          "id": "bTJkLNg8xtKhZJgL",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        320,
        5408
      ],
      "id": "535cad36-ad8e-4591-8a93-dafb7464386f",
      "name": "Espera_3_Segundos",
      "webhookId": "0a902838-3e8f-45d8-9b2e-8bc4950a8a84"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "Redis_Check_Final",
        "key": "=buffer:{{ $node[\"CheckOrigem\"].json.tecnico.session_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        480,
        5408
      ],
      "id": "8eda9515-bc0b-4bc3-9e87-d0b5020efe9c",
      "name": "Check_Pos_Espera",
      "alwaysOutputData": true,
      "credentials": {
        "redis": {
          "id": "bTJkLNg8xtKhZJgL",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "768c0bd8-dd6a-4825-94af-95a9c9d03ad5",
              "leftValue": "={{ $node[\"Agrupar_Texto\"].json.payload_id + \u0027_\u0027 + $execution.id }}",
              "rightValue": "={{ JSON.parse($json.Redis_Check_Final || \"[]\").slice(-1)[0].id + \u0027_\u0027 + JSON.parse($json.Redis_Check_Final || \"[]\").slice(-1)[0].exec_id }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        656,
        5408
      ],
      "id": "cccb5f15-a217-43bc-81dc-c4969ce41dea",
      "name": "Filtro_Ultima_Execucao"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "Redis_Check_Buffer",
        "key": "=buffer:{{ $(\u0027CheckOrigem\u0027).first().json.tecnico.session_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -144,
        5408
      ],
      "id": "8162f2eb-9da6-48df-85f2-eac5bdd87af1",
      "name": "Recuperar_Buffer",
      "alwaysOutputData": true,
      "credentials": {
        "redis": {
          "id": "bTJkLNg8xtKhZJgL",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "{{ $json.tecnico.isGroup }}",
                    "rightValue": "false",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9d8b45b5-c151-4e99-bdaf-6306764ea594"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "27953cd9-b238-4be3-9db8-7f15b5635ba4",
                    "leftValue": "{{ $json.tecnico.source }}",
                    "rightValue": "api",
                    "operator": {
                      "type": "string",
                      "operation": "notContains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "ffff129c-9a55-4c12-a18f-e84e087b7a88",
                    "leftValue": "{{ $json.tecnico.fromMe }}",
                    "rightValue": "false",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        1024,
        5376
      ],
      "id": "3abe8575-280d-44f8-81d7-7043ce1bbf19",
      "name": "SwitchOrigem"
    },
    {
      "parameters": {
        "jsCode": "// ==========================================================\n// 1. RECUPERAÃ‡ÃƒO DO NÃšMERO REAL (Do nÃ³ Consultar WAHA Direto)\n// ==========================================================\nlet phoneReal = \"\";\nlet nomeReal = \"Cliente\";\n\ntry {\n    // Pega o output da consulta que vocÃª fez na API\n    const dadosAPI = $(\u0027Consultar WAHA Direto\u0027).first().json;\n    \n    // O WAHA retorna o nÃºmero real em \u0027pn\u0027, \u0027id.user\u0027 ou \u0027id\u0027 dependendo da versÃ£o\n    const rawPhone = dadosAPI.pn || dadosAPI.id || \"\";\n    phoneReal = typeof rawPhone === \u0027string\u0027 ? rawPhone.split(\u0027@\u0027)[0].replace(/\\D/g, \u0027\u0027) : \"\";\n    \n    // PRIORIDADE DE CAPTURA DO NOME (ordem de preferÃªncia)\n    nomeReal = dadosAPI.pushname || dadosAPI.name || dadosAPI.notifyName || dadosAPI.verifiedName || \"Cliente\";\n} catch (error) {\n    phoneReal = $json.body.payload.from.split(\u0027@\u0027)[0];\n}\n\n// FALLBACK: Se ainda nÃ£o pegou o nome, tenta do payload direto\nif (nomeReal === \"Cliente\") {\n    try {\n        const payload = $json.body.payload || {};\n        const payloadData = payload._data || {};\n        nomeReal = payloadData.notifyName || payload.notifyName || payload.pushname || \"Cliente\";\n    } catch(e) {}\n}\n\n// ==========================================================\n// 2. RECUPERAÃ‡ÃƒO DOS DADOS BRUTOS (Do Webhook/Input)\n// ==========================================================\nconst inputData = $json; \nconst body = inputData.body || inputData;\nconst payload = body.payload || body || {};\n\nconst chatIdTecnico = payload.from || body.from;\nconst isGroup = String(chatIdTecnico).includes(\u0027@g.us\u0027);\n\nlet sessionId = body.session || \u0027default\u0027;\nif (!sessionId || sessionId === phoneReal) sessionId = \u0027default\u0027;\n\nlet userText = payload.body || \"\";\ntry {\n    const buffer = $(\u0027Agrupar_Texto\u0027).first().json;\n    if (buffer \u0026\u0026 buffer.texto_combinado) {\n        userText = buffer.texto_combinado;\n    }\n} catch(e) {}\n\n// ==========================================================\n// 3. MONTAGEM DO JSON FINAL\n// ==========================================================\nreturn {\n  json: {\n    \"tecnico\": {\n      \"session_id\": sessionId,\n      \"chat_id\": chatIdTecnico,\n      \"isGroup\": isGroup,\n      \"source\": body.source || \"api\",\n      \"fromMe\": payload.fromMe || false\n    },\n    \"cliente\": {\n      \"phoneNumber\": phoneReal,\n      \"nome_whatsapp\": nomeReal  // âœ… AGORA COM CAPTURA ROBUSTA\n    },\n    \"input_bruto\": {\n      \"user_text\": userText,\n      \"mediaType\": payload.type || \"chat\",\n      \"payload_id\": payload.id\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        5408
      ],
      "id": "e0d7b1ff-6001-4844-b8a5-324e757cbc05",
      "name": "CheckOrigem"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "sessaoExistente",
        "key": "=status_2fa:{{ $(\u0027Limpar Telefone\u0027).first().json.PhoneNumber }}",
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1376,
        5392
      ],
      "id": "49aa9477-d4ed-460d-8576-594140d1f4ba",
      "name": "Buscar_Sessao_Existente",
      "credentials": {
        "redis": {
          "id": "bTJkLNg8xtKhZJgL",
          "name": "Redis account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// =========================================================\n// 1. RECUPERAÃ‡ÃƒO DE DADOS (BANCO + WHATSAPP)\n// =========================================================\nlet cliente = {};\ntry { \n    const busca = $(\"Busca_Cliente\").first();\n    if (busca \u0026\u0026 busca.json \u0026\u0026 busca.json.id_cliente) {\n        cliente = busca.json;\n    }\n} catch(e) {}\n\nlet dadosWhatsApp = {};\ntry {\n    dadosWhatsApp = $(\"CheckOrigem\").first().json.cliente || {};\n} catch(e) {}\n\nconst phoneNumber = dadosWhatsApp.phoneNumber || \"\";\nconst nomeWhatsApp = dadosWhatsApp.nome_whatsapp || \"Cliente\";\nconst isClienteCadastrado = !!(cliente \u0026\u0026 cliente.id_cliente);\n\nlet consolidado = {};\ntry { consolidado = $(\"ConsolidarMensagem\").first().json || {}; } catch(e) {}\n\nlet perguntaAgente = consolidado.mensagem_final;\n\n// BLINDAGEM MASTER\nif (consolidado.teve_erro_ia) {\n    const msgRecomendada = (consolidado.tipo_entrada === \"image\") \n        ? \"Houve um erro tÃ©cnico ao processar a imagem do cliente. PeÃ§a educadamente para ele descrever o que deseja ou reenviar.\"\n        : \"Houve um erro tÃ©cnico ao transcrever o Ã¡udio do cliente. PeÃ§a para ele digitar ou enviar o Ã¡udio novamente.\";\n    perguntaAgente = `[SISTEMA]: ${msgRecomendada}`;\n} \nelse if (!perguntaAgente) {\n    perguntaAgente = (consolidado.tipo_entrada === \"chat\") ? \"OlÃ¡\" : \"...\";\n}\n\nlet isValid = false;\ntry {\n    const nodeRedis = $(\"Buscar_Sessao_Existente\").first();\n    if (nodeRedis \u0026\u0026 nodeRedis.json \u0026\u0026 nodeRedis.json.sessaoExistente === \"VALIDADO\") {\n        isValid = true;\n    }\n} catch (e) { isValid = false; }\n\n// =========================================================\n// 2. PROCESSAMENTO DE APÃ“LICES (V13 INTEGRAL)\n// =========================================================\nlet apolicesRaw = (cliente.apolices_detalhadas || []).filter(ap =\u003e \n    ap \u0026\u0026 ap.status_apolice \u0026\u0026 String(ap.status_apolice).toUpperCase() === \u0027ATIVA\u0027\n);\n\nconst apolicesContexto = apolicesRaw.map(ap =\u003e ({\n    seguradora: ap.seguradora,\n    tipo: ap.ramo,\n    status: ap.status_apolice,\n    apolice: isValid ? ap.numero_apolice : \"(Bloqueado)\",\n    vencimento: isValid ? ap.vigencia_fim : \"(Bloqueado)\",\n    placa: (ap.placa \u0026\u0026 isValid) ? ap.placa : (ap.placa ? \"***-****\" : \"N/A\"),\n    endereco: isValid ? (ap.endereco_apolice || \"NÃ£o informado\") : \"EndereÃ§o Oculto\",\n    cidade: isValid ? (ap.cidade_apolice || \"NÃ£o informado\") : \"Mascarado\",\n    uf: isValid ? (ap.uf_apolice || \"\") : \"\"\n}));\n\n// =========================================================\n// 3. CLASSIFICAÃ‡ÃƒO DE ROTA\n// =========================================================\nconst securityKeywords = /^(3|5|6|seguro|contratado|boleto|financeiro|sinistro|segunda|2a)|apolice|ap[oÃ³]lice|meus dados|minha ap/i;\nconst rota_num = securityKeywords.test(perguntaAgente || \"\") ? 1 : 0;\n\n// =========================================================\n// 4. RETORNO\n// =========================================================\nreturn [{\n    json: {\n        pergunta_cliente: perguntaAgente,\n        rota_num: rota_num,\n        contexto: {\n            nome: cliente.nome_completo || nomeWhatsApp,\n            cpf_real: cliente.cpf || \"\",\n            cpf_exibicao: (cliente.cpf) ? `***.***.***-${cliente.cpf.replace(/\\D/g, \"\").slice(-2)}` : \"NÃ£o informado\",\n            telefone: cliente.celular || phoneNumber,\n            email_cadastrado: cliente.email || \"\",\n            token_validado: isValid ? \"SIM\" : \"NÃƒO\",\n            cadastrado: isClienteCadastrado,\n            id_cliente: cliente.id_cliente || null,\n            input_user: perguntaAgente,\n            resumo_apolices: apolicesContexto,\n            tipo_cliente: isClienteCadastrado ? \"CADASTRADO\" : \"NOVO\",\n            mensagem_sistema: isClienteCadastrado \n                ? \"Cliente encontrado no sistema.\" \n                : \"Cliente novo - nÃ£o encontrado no cadastro.\"\n        }\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2576,
        5440
      ],
      "id": "58a88635-946b-49f8-bf5a-9b55c4856b1f",
      "name": "DefinirContextoAI",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $(\u0027Dados\u0027).first().json.type || \u0027chat\u0027 }}",
                    "rightValue": "audio|ptt",
                    "operator": {
                      "type": "string",
                      "operation": "regex"
                    },
                    "id": "0dc49c03-4595-4987-ac0a-3fc9d3a6155c"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6b2eacf3-4648-4f87-855c-274503889af2",
                    "leftValue": "={{ $(\u0027Dados\u0027).first().json.type || \u0027chat\u0027 }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7102c9ec-2c9e-4121-856c-7e44d524cbb7",
                    "leftValue": "={{ $(\u0027Dados\u0027).first().json.type || \u0027chat\u0027 }}",
                    "rightValue": "chat",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        1536,
        5376
      ],
      "id": "85c9cec0-8417-42f6-ba1d-1efaae532c89",
      "name": "SwitchMidia"
    },
    {
      "parameters": {
        "url": "={{ ($node[\"Dados\"].json.media_url || $node[\"Webhook\"].json.body.payload.url || \"\").replace(/https?:\\/\\/[^\\/]+/, \u0027http://waha:3000\u0027) }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wahaApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1808,
        5024
      ],
      "id": "2ca4918e-b8d8-4a6d-babc-e814bf531394",
      "name": "DownloadMidia",
      "alwaysOutputData": false,
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.0-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1984,
        5024
      ],
      "id": "48ccbcde-0249-4506-8f6f-ac5b495fbbf5",
      "name": "IA_Processar_Audio",
      "credentials": {
        "googlePalmApi": {
          "id": "zbgZENLaRF5SxXLc",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Em caso de erro, prossiga o chat."
    },
    {
      "parameters": {
        "url": "={{ ($node[\"Dados\"].json.media_url || $node[\"Webhook\"].json.body.payload.url || \"\").replace(/https?:\\/\\/[^\\/]+/, \u0027http://waha:3000\u0027) }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "wahaApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1808,
        5184
      ],
      "id": "0c0a5083-c7a7-4e21-aa7c-f3ecc5c7198c",
      "name": "ImageDownload",
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.0-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.0-flash"
        },
        "text": "=Analise a imagem e dÃª detalhes do que tem nela:\n  - Se for a imagem de um documento, procure fazer o reconhecimento atravÃ©s do tÃ­tulo ou qualquer coisa permita a correta identificaÃ§Ã£o\n  - Se for a imagem de um veiculo, procure identifica-lo (moto, carro ou caminhÃ£o), alÃ©m de modelo, cor e principalmente se identificado alguma batida etc. \n  - Se for qualquer outro tipo de imagem, analise de forma geral\n\nA pessoa que enviou essa imagem mencionou: {{ $node[\"CheckOrigem\"].json.input_bruto.user_text || \"NÃ£o mencionou nada\" }}",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        1984,
        5184
      ],
      "id": "870d662c-796e-405f-bf9b-227885792ab6",
      "name": "IA_Processar_Imagem",
      "credentials": {
        "googlePalmApi": {
          "id": "zbgZENLaRF5SxXLc",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Em caso de erro, prossiga o chat."
    },
    {
      "parameters": {
        "jsCode": "// 1. Pega dados de origem para saber o tipo real (chat ou mÃ­dia)\nlet origem = {};\ntry { origem = $(\"CheckOrigem\").first().json; } catch(e) {}\nconst tipoReal = origem.input_bruto?.mediaType || \"chat\";\nconst textoOriginal = origem.input_bruto?.user_text || \"\";\n\nlet transcricao = \"\";\nlet erroIA = false;\n\n// 2. SÃ“ BUSCA ERRO DE IA SE REALMENTE FOR MÃDIA\nif (tipoReal === \"audio\" || tipoReal === \"ptt\") {\n    try {\n        const nodeAudio = $(\"IA_Processar_Audio\").first();\n        if (nodeAudio.json.error || !nodeAudio.json.text || nodeAudio.json.text.includes(\"Erro\")) erroIA = true;\n        else transcricao = nodeAudio.json.text;\n    } catch(e) { erroIA = true; }\n} \nelse if (tipoReal === \"image\") {\n    try {\n        const nodeImagem = $(\"IA_Processar_Imagem\").first();\n        if (nodeImagem.json.error || !nodeImagem.json.text) erroIA = true;\n        else transcricao = nodeImagem.json.text;\n    } catch(e) { erroIA = true; }\n}\n\n// 3. Resultado Final\nlet mensagemFinal = (tipoReal === \"chat\") ? textoOriginal : transcricao;\n\n// Limpeza de placeholders residuais\nif (mensagemFinal === \"MIDIA_INPUT\") mensagemFinal = \"\";\n\nreturn [{\n    json: {\n        mensagem_final: mensagemFinal.trim(),\n        tipo_entrada: tipoReal,\n        teve_erro_ia: erroIA \u0026\u0026 (tipoReal !== \"chat\"),\n        houve_erro_midia: false \n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        5424
      ],
      "id": "1a6c5c5c-39fe-41df-896f-99da0c8a6fb8",
      "name": "ConsolidarMensagem",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.houve_erro_midia }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "5280c04a-9876-4f53-a252-2e8fff6d4d73"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "63991c1f-d6e5-45f5-a188-beca30f15b0c",
                    "leftValue": "={{ $json.houve_erro_midia }}",
                    "rightValue": "If Boolean is False: Conecte ao nÃ³ DefinirContextoAI.",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        2384,
        5424
      ],
      "id": "ff50d6d9-f861-4062-a737-6e0e1435ccd0",
      "name": "TratamentoErroMidia"
    },
    {
      "parameters": {
        "model": "google/gemini-2.0-flash",
        "options": {
          "maxTokens": 2048
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1216,
        6400
      ],
      "id": "601e9013-1ee8-4a16-99ec-58de67cc33dd",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "HzPUGkdiTBP5PHtz",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ (() =\u003e { try { const tel = $(\u0027DefinirContextoAI\u0027).first().json.contexto.telefone; if (tel) return tel + \u0027_v2\u0027; } catch(e) {} try { return $(\u0027MontarContextoPortal\u0027).first().json.session_key; } catch(e) {} return \u0027FALLBACK_\u0027 + Date.now(); })() }}",
        "contextWindowLength": 6
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        1408,
        6400
      ],
      "id": "9b34d508-4c86-4809-a642-9053d09114de",
      "name": "PostgresChatMemory",
      "credentials": {
        "postgres": {
          "id": "5ijVVKEpFAWPNF6w",
          "name": "brokeria_postgres_geral"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "NOME: Validador_Cliente_Brokeria\n\nQUANDO USAR:\n1. Quando um usuÃ¡rio desconhecido (telefone nÃ£o cadastrado) afirma ser cliente e fornece o documento ou e-mail.\n2. Quando um usuÃ¡rio jÃ¡ identificado solicita acesso a dados sensÃ­veis (apÃ³lices, alteraÃ§Ãµes cadastrais) e precisa revalidar a identidade.\n\nINPUT:\nO cliente deve fornecer o CPF (11 dÃ­gitos), CNPJ (14 dÃ­gitos) OU o E-mail cadastrado.\nExemplo JSON: { \"documento\": \"12345678900\" } ou { \"documento\": \"teste@email.com\" }\n\nRETORNO:\nRetorna os dados cadastrais completos do cliente. Retorna vazio se nÃ£o encontrar.",
        "operation": "executeQuery",
        "query": "SELECT * FROM public.clientes_brokeria\nWHERE cpf = \u0027{{\n  (() =\u003e {\n    const val = $json.documento ? $json.documento.toString() : \"\";\n    if (val.includes(\"@\")) return \"EMAIL_QUERY_BYPASS\";\n    const doc = val.replace(/\\D/g, \"\");\n    if (doc.length !== 11 \u0026\u0026 doc.length !== 14) return \"000\";\n    return doc;\n  })()\n}}\u0027 OR email = \u0027{{ $json.documento }}\u0027;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        1600,
        6400
      ],
      "id": "5cb24bdd-0c72-4faa-b26e-68e08b6025f2",
      "name": "QueryPostgresClientes",
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        624,
        4848
      ],
      "id": "a930ebb6-c18a-44c2-ad00-41a0ae411e6b",
      "name": "MergeDados"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f8eff236-eaf4-4910-8750-745c585893f0",
              "name": "wa.provider",
              "value": "waha",
              "type": "string"
            },
            {
              "id": "952635f9-b937-4076-8b4c-87e5b4dfaf5e",
              "name": "wa.session",
              "value": "={{$json.body.session}}",
              "type": "string"
            },
            {
              "id": "01f5d87e-4994-4995-a882-477a14b85ab6",
              "name": "wa.messageId",
              "value": "={{$json.body.payload.id}}",
              "type": "string"
            },
            {
              "id": "d875c982-ad5d-4098-b28f-ea116c24b210",
              "name": "wa.chatId",
              "value": "={{ $json.body.payload.from }}",
              "type": "string"
            },
            {
              "id": "16637790-2905-445d-a3f5-a280a1d7726c",
              "name": "wa.text",
              "value": "={{$json.body.payload.body}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        208,
        5024
      ],
      "id": "b344e8bf-7fbe-4e3c-92ad-3b375a2402fd",
      "name": "NormalizeInbound"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f13f09b9-af26-4aa3-9761-edc7d76ff32e",
              "name": "wa.chatId",
              "value": "={{ $json.pn || $json.wa.chatId }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        800,
        4832
      ],
      "id": "6edeffd4-b8b8-46d4-89f2-7674b07c8caa",
      "name": "FinalizeChatId"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "final_text",
              "name": "response_text",
              "value": "={{ $json.mensagem_final || $json.mensagem || $json.output || \"Erro: NÃ£o foi possÃ­vel recuperar a mensagem.\" }}",
              "type": "string"
            },
            {
              "id": "target_chat",
              "name": "target_chat_id",
              "value": "={{ $(\u0027DefinirContextoAI\u0027).first().json.contexto.telefone + \u0027@c.us\u0027 }}",
              "type": "string"
            },
            {
              "id": "target_session",
              "name": "target_session",
              "value": "={{ $(\u0027CheckOrigem\u0027).first().json.tecnico.session_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2352,
        5872
      ],
      "id": "c93daf48-fa9d-4dd1-8ac2-a43727f66d34",
      "name": "Padronizar Output"
    },
    {
      "parameters": {
        "jsCode": "// Este nÃ³ apenas coleta o que chegar e passa adiante\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2144,
        5872
      ],
      "id": "ded3cf27-6768-4d33-b995-5c624a6f530e",
      "name": "FunilRespostas"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.brokeria_registros_brokeria (\n  telefone_whatsapp, \n  nome_cliente, \n  resumo_conversa, \n  assunto_principal,\n  subtipo_solicitacao,\n  tipo_seguro,\n  prioridade,\n  tipo_cliente,\n  status_atendimento, \n  data_atendimento,\n  canal,\n  qtde_mensagens\n)\nVALUES (\n  \u0027{{ $(\"DefinirContextoAI\").first().json.contexto.telefone }}\u0027,\n  \u0027{{ $(\"DefinirContextoAI\").first().json.contexto.nome }}\u0027,\n  E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] \u0027 || \u0027{{ $(\"DefinirContextoAI\").first().json.contexto.nome }}\u0027 || E\u0027: \u0027 || \u0027{{ ($(\"DefinirContextoAI\").first().json.contexto.input_user || \"\").replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027 ||\n  E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] BrokerIA: \u0027 || \u0027{{ ($json.text || $json.output || \"\").replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027,\n  \u0027{{ $json.tipo_solicitacao || \"InformaÃ§Ãµes Gerais\" }}\u0027,\n  \u0027{{ $json.subtipo_solicitacao || \"DÃºvidas gerais\" }}\u0027,\n  \u0027{{ $json.tipo_seguro || \"OUTROS\" }}\u0027,\n  \u0027{{ $json.prioridade || \"MÃ©dia\" }}\u0027,\n  \u0027{{ $json.tipo_cliente || \"NÃ£o cliente\" }}\u0027,\n  \u0027PENDENTE\u0027,\n  CURRENT_DATE,\n  \u0027{{ $(\"DefinirContextoAI\").first().json.contexto.origem || \"WHATSAPP\" }}\u0027,\n  1\n)\nON CONFLICT (telefone_whatsapp, data_atendimento) \nDO UPDATE SET \n  resumo_conversa = brokeria_registros_brokeria.resumo_conversa || \n         E\u0027\\n\u0027 ||\n         E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] \u0027 || EXCLUDED.nome_cliente || E\u0027: \u0027 || \u0027{{ ($(\"DefinirContextoAI\").first().json.contexto.input_user || \"\").replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027 ||\n         E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] BrokerIA: \u0027 || \u0027{{ ($json.text || $json.output || \"\").replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027,\n  qtde_mensagens = COALESCE(brokeria_registros_brokeria.qtde_mensagens, 0) + 1,\n  assunto_principal = EXCLUDED.assunto_principal,\n  subtipo_solicitacao = EXCLUDED.subtipo_solicitacao,\n  prioridade = EXCLUDED.prioridade,\n  data_ultima_atualizacao = NOW();",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2528,
        5648
      ],
      "id": "ba46fd4c-9c39-44c2-842f-7f4741308505",
      "name": "Registrar_Interacao",
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 1. Coleta a mensagem de todas as fontes possÃ­veis\nlet mensagem = $json.response_text || $json.mensagem_final || $json.output || \"\";\n\n// 2. Se a mensagem ainda estiver vazia, tenta buscar diretamente nos nÃ³s de origem\nif (!mensagem || mensagem === \"\") {\n    try {\n        mensagem = $(\"LimparOutputValidacao\").first().json.mensagem_final;\n    } catch(e) {\n        try {\n            mensagem = $(\"BrokerIA_Master\").first().json.output;\n        } catch(e2) {}\n    }\n}\n\n// 3. Limpeza de logs tÃ©cnicos\nmensagem = mensagem.replace(/\\[Used tools:.*?\\]/gis, \u0027\u0027);\nmensagem = mensagem.replace(/Tool:.*?(?=\\n|$)/gi, \u0027\u0027);\nmensagem = mensagem.replace(/Input:.*?(?=\\n|$)/gi, \u0027\u0027);\nmensagem = mensagem.replace(/Result:.*?(?=\\n|$)/gi, \u0027\u0027);\nmensagem = mensagem.replace(/\\{.*?\"accepted\".*?\\}/gs, \u0027\u0027);\nmensagem = mensagem.replace(/\\n{3,}/g, \u0027\\n\\n\u0027).trim();\n\n// 4. âœ… CORREÃ‡ÃƒO: Fallback adequado baseado no tipo de cliente (Agora via v9)\nif (!mensagem) {\n    try {\n        const contexto = $(\"DefinirContextoAI\").first().json.contexto;\n        const nome = contexto.nome || \"Cliente\";\n        const primeiroNome = nome.split(\u0027 \u0027)[0];\n        const isClienteCadastrado = contexto.cadastrado; \n        \n        if (isClienteCadastrado) {\n            mensagem = `OlÃ¡ ${primeiroNome}! Como posso te ajudar hoje?`;\n        } else {\n            mensagem = `OlÃ¡ ${primeiroNome}! Seja bem-vindo Ã  DWF Seguros! ðŸ˜Š\\n\\nEstou aqui para te ajudar com:\\nâ€¢ CotaÃ§Ãµes de seguros\\nâ€¢ InformaÃ§Ãµes sobre nossos produtos\\nâ€¢ DÃºvidas sobre seguros em geral\\n\\nComo posso te ajudar?`;\n        }\n    } catch(e) {\n        mensagem = \"OlÃ¡! Seja bem-vindo Ã  DWF Seguros! Como posso te ajudar?\";\n    }\n}\n\nreturn {\n  json: {\n    ...$json,\n    text: mensagem\n  }\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2944,
        5872
      ],
      "id": "8b9e05b3-810c-4e71-8a1a-f5b425b38fe9",
      "name": "FiltrarResposta"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.pergunta_cliente }}\n\n",
        "options": {
          "systemMessage": "===================================================================\nðŸ“± FORMATO DE RESPOSTA (ESTILO MENU/URA) - CRÃTICO\n==================================================================\nPara melhorar a experiÃªncia do usuÃ¡rio, sempre que o cliente solicitar algo que tenha categorias ou variantes, APRESENTE AS OPÃ‡Ã•ES EM LISTA NUMERADA.\nO objetivo Ã© permitir que o cliente responda de forma rÃ¡pida e simples (apenas digitando o nÃºmero).\nEXEMPLO DE INTERAÃ‡ÃƒO OBRIGATÃ“RIA:\nCliente: \"Quero uma cotaÃ§Ã£o\"\nVocÃª: \"Ã“timo! Para qual tipo de seguro vocÃª deseja cotaÃ§Ã£o?\n1. AutomÃ³vel ðŸš—\n2. Residencial ðŸ \n3. Vida â¤ï¸\n4. Empresarial ðŸ¢\n5. Outros AssistÃªncias\"\nPRIORIZE SEMPRE esse formato de \"URA Inteligente/Menu\" em vez de perguntas abertas.\n\n=================================================================\nðŸŒ PORTAL DO CLIENTE - ACESSO SEGURO A DADOS\n=================================================================\nQualquer solicitaÃ§Ã£o abaixo DEVE ser respondida com redirecionamento ao portal:\n- Documentos (PDFs de apÃ³lices, cartas verdes, 2Âª via)\n- Dados detalhados alÃ©m do resumo disponÃ­vel no contexto\n- AlteraÃ§Ãµes cadastrais\n\nâœ… RESPOSTA PADRÃƒO para esses casos:\n\"Para acessar seus dados e documentos com seguranÃ§a, acesse nosso portal:\nðŸ”— https://brokeria-api-brokeriaweb.cx0m9g.easypanel.host/login.html\n\nLÃ¡ vocÃª encontra todas as suas informaÃ§Ãµes e pode baixar seus documentos! ðŸ˜Š\"\n\nEXEMPLOS que devem ir ao portal:\n- \"Me envie a 2Âª via da apÃ³lice\" â†’ portal\n- \"Qual o endereÃ§o da minha apÃ³lice?\" â†’ portal\n- \"Quero alterar meu cadastro\" â†’ portal\n\nEXEMPLOS que NÃƒO vÃ£o ao portal (responda com o contexto):\n- \"Qual o nÃºmero da minha apÃ³lice?\" â†’ use resumo_apolices do contexto\n- \"Quando vence meu seguro?\" â†’ use resumo_apolices do contexto\n- \"Qual a placa do meu carro segurado?\" â†’ use resumo_apolices do contexto\n- SaudaÃ§Ãµes e perguntas gerais â†’ responda normalmente\n\n=================================================================\nðŸ“ REGISTRO DE COTAÃ‡Ã•ES - REGRA OBRIGATÃ“RIA\n=================================================================\nQuando o cliente solicitar uma cotaÃ§Ã£o E vocÃª jÃ¡ tiver: Nome, Email e Tipo de seguro:\n1. Chame IMEDIATAMENTE a ferramenta \u0027EspecialistaRegistroCotacao\u0027\n2. Passe: nome, email, tipo_seguro, mensagem\n3. AGUARDE a confirmaÃ§Ã£o da tool\n4. SÃ³ DEPOIS confirme: \"âœ… Sua solicitaÃ§Ã£o foi registrada! O corretor Washington entrarÃ¡ em contato em breve.\"\n\nNUNCA confirme sem a tool retornar sucesso.\n\n-----------------------------------------------------------------\nðŸ”Ž CONTEXTO DINÃ‚MICO\n-----------------------------------------------------------------\n- Cliente: {{ $json.contexto.nome }}\n- CPF: {{ $json.contexto.cpf_exibicao }}\n- Telefone: {{ $json.contexto.telefone }}\n- Email Cadastrado: {{ $json.contexto.email_cadastrado }}\n\nðŸ“± CENÃRIO A: CLIENTE CADASTRADO\n- SaÃºde pelo PRIMEIRO NOME: \"OlÃ¡, {{ $json.contexto.nome }}!\"\n- Dados bÃ¡sicos das apÃ³lices disponÃ­veis no contexto abaixo\n- Para documentos/dados detalhados â†’ portal\n- NÃƒO peÃ§a CPF se jÃ¡ estiver no contexto\n\nðŸ“± CENÃRIO B: TELEFONE NÃƒO CADASTRADO (novo contato)\n- Use o nome do WhatsApp: \"OlÃ¡, {{ $json.contexto.nome }}!\"\n- Se mencionar que Ã‰ cliente, peÃ§a CPF â†’ use QueryPostgresClientes\n- ApÃ³s encontrar: \"Perfeito! Localizei seu cadastro. Como posso ajudar?\"\n\nðŸ“± CENÃRIO C: CLIENTE MENCIONA CPF ESPONTANEAMENTE\n- Use QueryPostgresClientes com { \"documento\": \"CPF_INFORMADO\" }\n- Se encontrar â†’ trate como CENÃRIO A\n\nâš ï¸ SAUDAÃ‡ÃƒO: NUNCA diga \"OlÃ¡, NÃ£o Identificado!\" ou \"OlÃ¡, Cliente!\"\n\nðŸ“Š RESUMO DE APÃ“LICES (dados bÃ¡sicos disponÃ­veis):\n{{ JSON.stringify($json.contexto.resumo_apolices) }}\n\n=================================================================\nðŸ“‹ INFORMAÃ‡Ã•ES INSTITUCIONAIS\n=================================================================\nResponsÃ¡vel: Washington William de Oliveira â€“ Susep: 10.2028529.9\nEmail: contato@dwfseguros.com.br\nWebsite: https://www.dwfseguros.com.br\nTIPOS DE SEGUROS: AutomÃ³vel, Residencial, Vida, SaÃºde, PrevidÃªncia, Frota, Resp. Civil, Transportes, Garantia, etc.\n\n=================================================================\nðŸš« LIMITES E LGPD\n=================================================================\n- COTAÃ‡Ã•ES: NUNCA forneÃ§a valores de prÃªmio. Diga: \"A cotaÃ§Ã£o oficial serÃ¡ feita pelo corretor Washington\".\n- CPF/CNPJ: SEMPRE mascarado. Ex: ***.***.***-22\n- Para dados alÃ©m do contexto â†’ redirecione ao portal\n- Seja formal, consultivo e simpÃ¡tico. Saude sempre pelo primeiro nome.\n- NUNCA invente informaÃ§Ãµes.",
          "maxIterations": 10
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1424,
        5872
      ],
      "id": "6e2a1dbc-1160-4c29-a70a-a070ba8af73b",
      "name": "BrokerIA_Master",
      "executeOnce": false,
      "alwaysOutputData": false,
      "notesInFlow": false
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.contexto.tipo_cliente }}",
                    "rightValue": "=NOVO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "75010c00-aec1-42d3-ae87-3d67526f7c3b"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "d4159ee7-e43a-477d-90f3-a5e7ac29d9d5",
                    "leftValue": "={{ $json.contexto.tipo_cliente }}",
                    "rightValue": "=CADASTRADO",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        3936,
        5424
      ],
      "id": "98738341-404f-4110-b56f-f3c3dcff6286",
      "name": "Check_Cliente_Novo"
    },
    {
      "parameters": {
        "jsCode": "// RECUPERA DADOS\nconst contexto = $json.contexto || {};\nconst pergunta = $json.pergunta_cliente || \"\";\nconst perguntaLower = pergunta.toLowerCase();\n\n// ==========================================\n// 1. RAMO DO SEGURO (Mapeamento Inteligente)\n// ==========================================\nlet ramoSeguro = \"OUTROS\";\nif (perguntaLower.match(/auto|carro|veic|moto|placa/)) ramoSeguro = \"AUTOMOVEL\";\nelse if (perguntaLower.match(/casa|resid|apart|lar|home/)) ramoSeguro = \"RESIDENCIAL\";\nelse if (perguntaLower.match(/vida|falec|morte|funeral/)) ramoSeguro = \"VIDA\";\nelse if (perguntaLower.match(/saude|mÃ©dic|plano|hospit/)) ramoSeguro = \"SAUDE\";\nelse if (perguntaLower.match(/empresa|pj|comercial/)) ramoSeguro = \"EMPRESARIAL\";\n\n// ==========================================\n// 2. NÃVEL 1 E NÃVEL 2 (ClassificaÃ§Ã£o)\n// ==========================================\nlet nivel1 = \"InformaÃ§Ãµes Gerais\";\nlet nivel2 = \"DÃºvidas gerais sobre seguros\";\nlet prioridade = \"MÃ©dia\";\n\n// LÃ³gica de ClassificaÃ§Ã£o HierÃ¡rquica\nif (perguntaLower.match(/cotaÃ§Ã£o|cotacao|quanto custa|valor|preÃ§o|contratar/)) {\n    nivel1 = \"Vendas e CotaÃ§Ãµes\";\n    nivel2 = \"CotaÃ§Ã£o de seguro novo\";\n    prioridade = \"Alta\";\n} else if (perguntaLower.match(/sinistro|bati|acidente|roubo|furto|colisÃ£o/)) {\n    nivel1 = \"Sinistros\";\n    nivel2 = \"Aviso de sinistro\";\n    prioridade = \"CrÃ­tica\";\n} else if (perguntaLower.match(/boleto|pagar|parcela|paguei|segunda via|2 via/)) {\n    nivel1 = \"Financeiro\";\n    nivel2 = \"Segunda via de boleto\";\n} else if (perguntaLower.match(/renovar|renovaÃ§Ã£o|vencimento|venceu/)) {\n    nivel1 = \"RenovaÃ§Ã£o\";\n    nivel2 = \"RenovaÃ§Ã£o automÃ¡tica\";\n    prioridade = \"Alta\";\n} else if (perguntaLower.match(/cancelar|cancelamento|desistir/)) {\n    nivel1 = \"Cancelamento\";\n    nivel2 = \"Cancelamento a pedido do cliente\";\n    prioridade = \"Alta\";\n} else if (perguntaLower.match(/apolice|apÃ³lice|documento|certificado|carta/)) {\n    nivel1 = \"Documentos\";\n    nivel2 = \"Segunda via de apÃ³lice\";\n} else if (perguntaLower.match(/mudei|endereÃ§o|troquei|dados|alterar/)) {\n    nivel1 = \"AlteraÃ§Ãµes de ApÃ³lice (Endossos)\";\n    nivel2 = \"AtualizaÃ§Ã£o de dados cadastrais\";\n}\n\n// ==========================================\n// 3. RETORNO FORMATADO PARA O POSTGRES\n// ==========================================\nreturn {\n    json: {\n        telefone: (contexto.telefone || \"\").replace(/\\D/g, \u0027\u0027),\n        nome_whatsapp: (contexto.nome || \"Cliente\"),\n        mensagem_inicial: pergunta,\n        \n        // PadronizaÃ§Ã£o solicitada\n        tipo_solicitacao: nivel1,          // NÃ­vel 1\n        subtipo_solicitacao: nivel2,       // NÃ­vel 2\n        tipo_seguro: ramoSeguro,           // Ramo\n        prioridade: prioridade,            // Prioridade\n        tipo_cliente: contexto.cadastrado ? \"Cliente existente\" : \"NÃ£o cliente\",\n        \n        status_atendimento: \"PENDENTE\",\n        origem: \"WHATSAPP\",\n        data_contato: new Date()\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4064,
        5264
      ],
      "id": "bf04d374-7095-4254-8afe-987824f6a1c8",
      "name": "Preparar_Registro_Cliente"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    id_atendimento,\n    telefone_whatsapp,\n    nome_cliente,\n    resumo_conversa,\n    assunto_principal,\n    status_atendimento,\n    qtde_mensagens,\n    data_atendimento\nFROM public.brokeria_registros_brokeria\nWHERE telefone_whatsapp = \u0027{{ $json.telefone }}\u0027\n  AND data_atendimento \u003e NOW() - INTERVAL \u002724 hours\u0027\nORDER BY data_atendimento DESC\nLIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4272,
        5264
      ],
      "id": "f61b9514-92e4-466b-bd88-1d16448d70fa",
      "name": "Verificar_Registro_Existente",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.id_atendimento ? String($json.id_atendimento) : \u0027\u0027 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "empty",
                      "singleValue": true
                    },
                    "id": "f21a439a-8d76-455e-8135-20ce8961a9cd"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "32739ffd-b920-42b7-91e3-cc77369defd7",
                    "leftValue": "={{ $json.id_atendimento ? String($json.id_atendimento) : \u0027\u0027 }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        4480,
        5264
      ],
      "id": "4eaa15af-47c8-43b5-bbb5-f03dc3700e6c",
      "name": "Switch_Registro_Existe"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.brokeria_registros_brokeria (\n    telefone_whatsapp,\n    nome_cliente,\n    resumo_conversa,    -- Ajustado para o padrÃ£o do Dashboard\n    assunto_principal,\n    canal,\n    status_atendimento,\n    qtde_mensagens,\n    recebeu_arquivos,\n    tipos_documentos,\n    etapa_funil,\n    data_atendimento,\n    hora_inicio\n) VALUES (\n    \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.telefone }}\u0027,\n    \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.nome_whatsapp }}\u0027,\n    -- Inicia o log jÃ¡ formatado\n    E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] \u0027 || \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.nome_whatsapp }}\u0027 || E\u0027: \u0027 || \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.mensagem_inicial.replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027,\n    \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.tipo_solicitacao }}\u0027,\n    \u0027WHATSAPP\u0027,\n    \u0027PENDENTE\u0027,\n    1,\n    {{ $(\"Preparar_Registro_Cliente\").first().json.recebeu_arquivos || false }},\n    \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.tipos_documentos || \"\" }}\u0027,\n    \u0027PRIMEIRO_CONTATO\u0027,\n    NOW(),\n    NOW()\n)\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4688,
        5072
      ],
      "id": "69249b3e-3a8c-4c1e-a2aa-3952b45d3c05",
      "name": "Inserir_Novo_Registro",
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.brokeria_registros_brokeria\nSET \n    -- Adiciona a nova mensagem do cliente mantendo o formato [HH:MM]\n    resumo_conversa = resumo_conversa || \n        E\u0027\\n\u0027 ||\n        E\u0027[\u0027 || TO_CHAR(NOW() AT TIME ZONE \u0027UTC\u0027 AT TIME ZONE \u0027America/Sao_Paulo\u0027, \u0027HH24:MI, DD/MM/YYYY\u0027) || E\u0027] \u0027 || \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.nome_whatsapp }}\u0027 || E\u0027: \u0027 || \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.mensagem_inicial.replace(/\u0027/g, \"\u0027\u0027\") }}\u0027 || E\u0027\\n\u0027,\n    assunto_principal = \u0027{{ $(\"Preparar_Registro_Cliente\").first().json.tipo_solicitacao }}\u0027,\n    qtde_mensagens = COALESCE(qtde_mensagens, 0) + 1,\n    data_ultima_atualizacao = NOW()\nWHERE id_atendimento = {{ $json.id_atendimento }}\nRETURNING *;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4704,
        5280
      ],
      "id": "981333ac-0559-4767-931c-855bd98594d5",
      "name": "Atualizar_Registro_Existente",
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4960,
        5392
      ],
      "id": "8edf33f8-2158-4a80-9612-51f761ba20e4",
      "name": "Merge_Registro"
    },
    {
      "parameters": {
        "description": "Use esta ferramenta OBRIGATORIAMENTE quando o cliente solicitar uma cotaÃ§Ã£o de seguro E fornecer nome e-mail e tipo de seguro. Esta tool registra a solicitaÃ§Ã£o no sistema para que o corretor Washington entre em contato. IMPORTANTE: SÃ³ chame esta tool APOS coletar nome e-mail e tipo de seguro do cliente.",
        "workflowId": {
          "__rl": true,
          "value": "jzIUf4Qlnf2bunJx599mp",
          "mode": "list",
          "cachedResultUrl": "/workflow/jzIUf4Qlnf2bunJx599mp",
          "cachedResultName": "EspecialistaRegistroCotacao"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefone": "={{ $(\u0027NormalizarEntrada\u0027).first().json.contexto.telefone }}",
            "nome": "={{ $json.nome || $(\u0027NormalizarEntrada\u0027).first().json.contexto.nome }}",
            "email": "={{ $json.email }}",
            "tipo_seguro": "={{ $json.tipo_seguro }}",
            "mensagem": "={{ $(\u0027NormalizarEntrada\u0027).first().json.pergunta_cliente || $json.mensagem || \u0027SolicitaÃ§Ã£o de cotaÃ§Ã£o via WhatsApp\u0027 }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefone",
              "displayName": "telefone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "nome",
              "displayName": "nome",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "tipo_seguro",
              "displayName": "tipo_seguro",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "mensagem",
              "displayName": "mensagem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1792,
        6400
      ],
      "id": "38875765-a0cc-4f13-a0a0-9203dee0898b",
      "name": "EspecialistaRegistroCotacao"
    },
    {
      "parameters": {
        "jsCode": "// RECUPERA DADOS (Tenta buscar de vÃ¡rias fontes comuns no seu fluxo)\nconst contexto = $json.contexto || {};\nconst inputUser = contexto.input_user || $json.pergunta_cliente || \"\";\nconst perguntaLower = inputUser.toLowerCase();\n\n// ==========================================\n// 1. RAMO DO SEGURO (Mapeamento Inteligente)\n// ==========================================\n// Para clientes existentes, se jÃ¡ tivermos o ramo no contexto, usamos ele.\nlet ramoSeguro = contexto.ramo_seguro || \"OUTROS\";\n\nif (ramoSeguro === \"OUTROS\") {\n    if (perguntaLower.match(/auto|carro|veic|moto|placa/)) ramoSeguro = \"AUTOMOVEL\";\n    else if (perguntaLower.match(/casa|resid|apart|lar|home/)) ramoSeguro = \"RESIDENCIAL\";\n    else if (perguntaLower.match(/vida|falec|morte|funeral/)) ramoSeguro = \"VIDA\";\n    else if (perguntaLower.match(/saude|mÃ©dic|plano|hospit/)) ramoSeguro = \"SAUDE\";\n    else if (perguntaLower.match(/empresa|pj|comercial/)) ramoSeguro = \"EMPRESARIAL\";\n}\n\n// ==========================================\n// 2. NÃVEL 1 E NÃVEL 2 (ClassificaÃ§Ã£o de Chamado)\n// ==========================================\nlet nivel1 = \"InformaÃ§Ãµes Gerais\";\nlet nivel2 = \"DÃºvidas gerais sobre seguros\";\nlet prioridade = \"MÃ©dia\";\n\n// LÃ³gica para Clientes Existentes (Foco em PÃ³s-Venda/ServiÃ§o)\nif (perguntaLower.match(/sinistro|bati|acidente|roubo|furto|colisÃ£o/)) {\n    nivel1 = \"Sinistros\";\n    nivel2 = \"Aviso de sinistro\";\n    prioridade = \"CrÃ­tica\";\n} else if (perguntaLower.match(/boleto|pagar|parcela|paguei|segunda via|2 via/)) {\n    nivel1 = \"Financeiro\";\n    nivel2 = \"Segunda via de boleto\";\n} else if (perguntaLower.match(/renovar|renovaÃ§Ã£o|vencimento|venceu/)) {\n    nivel1 = \"RenovaÃ§Ã£o\";\n    nivel2 = \"RevisÃ£o de valor\";\n    prioridade = \"Alta\";\n} else if (perguntaLower.match(/apolice|apÃ³lice|documento|certificado|carta/)) {\n    nivel1 = \"Documentos\";\n    nivel2 = \"Segunda via de apÃ³lice\";\n} else if (perguntaLower.match(/mudei|endereÃ§o|troquei|dados|alterar/)) {\n    nivel1 = \"AlteraÃ§Ãµes de ApÃ³lice (Endossos)\";\n    nivel2 = \"AtualizaÃ§Ã£o de dados cadastrais\";\n} else if (perguntaLower.match(/cancelar|cancelamento|desistir/)) {\n    nivel1 = \"Cancelamento\";\n    nivel2 = \"Cancelamento a pedido do cliente\";\n    prioridade = \"Alta\";\n} else if (perguntaLower.match(/reclamaÃ§Ã£o|ruim|errado|elogio|queixa/)) {\n    nivel1 = \"PÃ³s-venda e Relacionamento\";\n    nivel2 = \"ReclamaÃ§Ã£o geral\";\n} else if (perguntaLower.match(/cotaÃ§Ã£o|cotacao|seguro novo|outro carro/)) {\n    nivel1 = \"Vendas e CotaÃ§Ãµes\";\n    nivel2 = \"CotaÃ§Ã£o de seguro novo\";\n    prioridade = \"Alta\";\n}\n\n// ==========================================\n// 3. RETORNO PARA O REGISTRO (Com \"Spread\" para manter dados da IA)\n// ==========================================\nreturn {\n    json: {\n        ...$json, // ðŸ‘ˆ ISSO Ã‰ VITAL: MantÃ©m a resposta da IA (output) vinda do FunilRespostas\n        \n        // Seus novos campos padronizados\n        tipo_solicitacao: nivel1,\n        subtipo_solicitacao: nivel2,\n        tipo_seguro: ramoSeguro,\n        prioridade: prioridade,\n        tipo_cliente: \"Cliente existente\",\n        \n        // Dados do Cliente\n        telefone: (contexto.telefone || \"\").replace(/\\D/g, \u0027\u0027),\n        nome_whatsapp: (contexto.nome || \"Cliente\")\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        5648
      ],
      "id": "e3e2ca82-eede-4a70-b7d4-6eb17f307473",
      "name": "Preparar_Registro_Cliente_Existente"
    },
    {
      "parameters": {
        "jsCode": "// Captura o input do nÃ³ anterior\nconst input = $input.first().json;\n\n// Se o webhook agora envia apenas o body, o \u0027input\u0027 jÃ¡ Ã© o conteÃºdo direto\nconst data = input;\n\nlet perguntaFinal = data.pergunta_cliente || data.pergunta || \"OlÃ¡\";\nlet contextoFinal = data.contexto || {};\n\n// IdentificaÃ§Ã£o robusta: Se tiver \u0027action\u0027 ou \u0027token\u0027 e nÃ£o tiver \u0027contexto\u0027 estruturado, tratamos como Portal Web Inicial\nconst isPortalWebInicial = (data.action || data.token) \u0026\u0026 (!data.contexto || Object.keys(data.contexto).length === 0);\n\nif (isPortalWebInicial) {\n    const rawIdentifier = data.cpf || data.identifier || data.cpf_cnpj || \"\";\n    const cpfLimpo = rawIdentifier.toString().replace(/\\D/g, \u0027\u0027);\n\n    contextoFinal = {\n        nome: data.client_name || data.nome || \"Visitante Web\",\n        email_cadastrado: data.target || data.email || null,\n        cpf_real: cpfLimpo || null, \n        origem: \"PORTAL_WEB\",\n        token_portal: data.token || null, \n        action: data.action || null,\n        tipo_cliente: \"CADASTRADO\",\n        token_validado: \"NÃƒO\"\n    };\n\n    if (data.action === \"SEND_2FA_TOKEN\") {\n        if (!contextoFinal.cpf_real) {\n            perguntaFinal = `[PROTOCOLO DE SEGURANÃ‡A]: O cliente ${contextoFinal.nome} deseja receber seu cÃ³digo no e-mail ${contextoFinal.email_cadastrado}.\\n\\n### ATENÃ‡ÃƒO AGENTE ###\\nO CPF nÃ£o foi enviado pelo portal. VocÃª Ã© OBRIGADO a seguir estes passos:\\n1. Use a tool \u0027Validador_Cliente_Brokeria\u0027 passando o e-mail \u0027${contextoFinal.email_cadastrado}\u0027 no campo \u0027documento\u0027.\\n2. Identifique o CPF retornado pelo banco.\\n3. Agora sim, chame \u0027AgentEnviaToken\u0027 informando o E-mail, o CPF localizado e o Token: ${contextoFinal.token_portal}.`;\n        } else {\n            perguntaFinal = `[PROTOCOLO DE SEGURANÃ‡A]: O cliente ${contextoFinal.nome} deseja receber seu cÃ³digo de acesso.\\n- E-mail: ${contextoFinal.email_cadastrado}\\n- CPF: ${contextoFinal.cpf_real}\\n- CÃ³digo (Token): ${contextoFinal.token_portal}\\n\\nChame a ferramenta AgentEnviaToken IMEDIATAMENTE.`;\n        }\n    } else {\n        contextoFinal.token_validado = \"SIM\";\n    }\n} else {\n    // Fluxo normal (WhatsApp ou Contexto jÃ¡ pronto)\n    contextoFinal.token_validado = contextoFinal.token_validado || \"NÃƒO\";\n}\n\nlet telefoneDb = contextoFinal.telefone || data.telefone || \"VISITANTE_WEB\";\nif (contextoFinal.cpf_real) {\n    telefoneDb = \"WEB_\" + contextoFinal.cpf_real;\n}\n\ncontextoFinal.tipo_cliente = contextoFinal.tipo_cliente || \"CADASTRADO\";\n// CERTO (Ajustado)\n// Se nÃ£o for Portal Web Inicial, e nÃ£o tiver origem, assume WHATSAPP\ncontextoFinal.origem = contextoFinal.origem || \"WHATSAPP\"; \nreturn [{\n    json: {\n        pergunta_cliente: perguntaFinal,\n        contexto: contextoFinal,\n        telefone: telefoneDb,\n        nome_whatsapp: contextoFinal.nome || \"Visitante Web\",\n        origem: contextoFinal.origem // Preserve o valor definido acima\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        5424
      ],
      "id": "feff5dc1-d7ab-46fc-8eef-616eabfa2fa5",
      "name": "NormalizarEntrada"
    },
    {
      "parameters": {
        "jsCode": "// =========================================================\n// 1. CAPTURA DE DADOS (Diferencia Portal Web de WhatsApp)\n// =========================================================\nconst inputData = $input.first().json;\nlet contexto = inputData.contexto || {};\nlet perguntaCliente = inputData.pergunta_cliente || \"\";\n\n// Se a pergunta estiver vazia, significa que veio do fluxo do WhatsApp\nif (!perguntaCliente) {\n    try {\n        // Busca o contexto gerado internamente pelo nÃ³ anterior do seu fluxo\n        const nodeContexto = $(\"DefinirContextoAI\").first().json;\n        contexto = nodeContexto.contexto || {};\n        perguntaCliente = nodeContexto.pergunta_cliente || \"\";\n    } catch(e) {\n        console.log(\"Aviso: NÃ£o foi possÃ­vel recuperar contexto via nÃ³ DefinirContextoAI\");\n    }\n}\n\n// =========================================================\n// 2. RECUPERAÃ‡ÃƒO DE LOGS (Dados do Registro no Postgres)\n// =========================================================\n// Tenta pegar o histÃ³rico de conversa caso jÃ¡ exista um atendimento aberto\nlet dadosRegistro = {};\ntry {\n    const mergeNode = $(\"Merge_Registro\").first().json;\n    dadosRegistro = mergeNode || {};\n} catch(e) {\n    console.log(\"Aviso: Dados do Merge_Registro nÃ£o encontrados\");\n}\n\n// =========================================================\n// 3. FALLBACK DE PERGUNTA\n// =========================================================\n// Se ainda assim a pergunta estiver vazia, mas houver histÃ³rico no banco, tenta pegar a Ãºltima linha\nif (!perguntaCliente \u0026\u0026 dadosRegistro.resumo_conversa) {\n    const mensagens = dadosRegistro.resumo_conversa.split(\u0027--- Nova mensagem em\u0027);\n    const ultimaMensagem = mensagens[mensagens.length - 1];\n    perguntaCliente = ultimaMensagem\n        .replace(/---/g, \u0027\u0027)\n        .replace(/\\d{4}-\\d{2}-\\d{2}.*?---/g, \u0027\u0027)\n        .trim();\n}\n\n// Fallback final de seguranÃ§a (Garanti que a IA nunca receba vazio)\nif (!perguntaCliente) {\n    perguntaCliente = \"OlÃ¡\";\n}\n\n// =========================================================\n// 4. RETORNO FINAL (O que o seu \"BrokerIA_Master\" vai ler)\n// =========================================================\nreturn {\n    json: {\n        pergunta_cliente: perguntaCliente,\n        contexto: contexto,\n        id_atendimento: dadosRegistro.id_atendimento || null,\n        origem_tecnica: inputData.contexto?.origem || \"WHATSAPP\"\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        5728
      ],
      "id": "a10ebecd-1344-4ee0-a946-b9a6d828ee1a",
      "name": "Preparar_Input_Agent"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "==buffer:{{ $(\u0027CheckOrigem\u0027).first().json.tecnico.session_id }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        864,
        5392
      ],
      "id": "d8e3eda1-a904-4b6f-8ab2-cf9d04f08b93",
      "name": "Limpar_Buffer_Pos_Execucao",
      "credentials": {
        "redis": {
          "id": "bTJkLNg8xtKhZJgL",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "default",
        "chatId": "={{ $(\u0027DefinirContextoAI\u0027).item.json.contexto.telefone }}@c.us",
        "text": "=ðŸ”’ *AutorizaÃ§Ã£o de Acesso Seguro*\n\nPara visualizar seus dados, clique no link abaixo:\nðŸ”— {{ $json.link }}\n\nâ± Este link expira em *15 minutos*.\nApÃ³s clicar, seus dados serÃ£o liberados aqui mesmo no WhatsApp!",
        "requestOptions": {}
      },
      "type": "n8n-nodes-waha.WAHA",
      "typeVersion": 202411,
      "position": [
        3552,
        5024
      ],
      "id": "4531303f-713e-4b21-9b72-4477e33e877b",
      "name": "Avisa Cliente",
      "credentials": {
        "wahaApi": {
          "id": "RynISmV7FrfCHYOX",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f2bec8d6-5b1c-4b1f-b994-6ead7c5765b8",
              "leftValue": "={{ $json.rota_num }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2736,
        5440
      ],
      "id": "4084fc0b-dc1b-4c8a-9cf0-7264627360f9",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://brokeria-api-brokeriaweb.cx0m9g.easypanel.host/api/magic-link/generate",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phoneNumber",
              "value": "={{ $json.contexto.telefone }}"
            },
            {
              "name": "cpf",
              "value": "={{ $json.contexto.cpf_real }}"
            },
            {
              "name": "email",
              "value": "={{ $json.contexto.email_cadastrado }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3360,
        5024
      ],
      "id": "8c03f989-6aca-4f94-af9d-f261c819dabf",
      "name": "http"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "1584a886-e46b-43fb-b88d-1007f9267648",
              "leftValue": "={{ $json.contexto.token_validado === \"SIM\" }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2928,
        5344
      ],
      "id": "cc2a7289-e230-4970-9fd3-2bb8045ac73c",
      "name": "IF-Validado"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "portal-web-chat",
        "responseMode": "lastNode",
        "responseData": "body",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -128,
        6800
      ],
      "id": "aab12345-0001-4000-b000-000000000001",
      "name": "WebhookPortal",
      "webhookId": "portal-web-chat"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.body || $input.first().json;\nconst cpf = (data.cpf || data.identifier || data.user_cpf || \u0027\u0027).replace(/\\D/g, \u0027\u0027);\nconst nome = data.client_name || data.nome || \u0027Cliente\u0027;\nconst email = data.email || \u0027\u0027;\nconst telefone = (data.telefone || data.target || \u0027\u0027).replace(/\\D/g, \u0027\u0027);\nconst pergunta = data.pergunta_cliente || data.message || data.pergunta || \u0027Ola\u0027;\n// OMNICHANNEL: mesma chave do WhatsApp =\u003e mesma memoria Postgres\nconst sessionKey = telefone ? telefone + \u0027_v2\u0027 : \u0027PORTAL_SEM_FONE_\u0027 + (cpf || Date.now());\nreturn [{ json: { pergunta_cliente: pergunta, session_key: sessionKey, cpf_portal: cpf, email_portal: email, nome_portal: nome, telefone_portal: telefone, contexto: { nome: nome, cpf_real: cpf, cpf_exibicao: cpf ? \u0027***.***.***-\u0027 + cpf.slice(-2) : \u0027Nao informado\u0027, telefone: telefone, email_cadastrado: email, token_validado: \u0027SIM\u0027, cadastrado: true, origem: \u0027PORTAL_WEB\u0027, tipo_cliente: \u0027CADASTRADO\u0027, resumo_apolices: [] } }}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        6800
      ],
      "id": "aab12345-0002-4000-b000-000000000002",
      "name": "NormalizarPortal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT c.nome_completo, c.cpf, c.email, c.celular, (SELECT json_agg(a) FROM public.apolices_brokeria a WHERE a.id_cliente::text = c.id_cliente::text AND UPPER(a.status_apolice) = \u0027ATIVA\u0027) as apolices_ativas FROM public.clientes_brokeria c WHERE REPLACE(REPLACE(c.cpf, \u0027.\u0027, \u0027\u0027), \u0027-\u0027, \u0027\u0027) = \u0027{{ $json.cpf_portal }}\u0027 LIMIT 1;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        480,
        6800
      ],
      "id": "aab12345-0003-4000-b000-000000000003",
      "name": "BuscaClientePortal",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "xV5DoCDtV27fCFr5",
          "name": "brokeria_db"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const norm = $(\u0027NormalizarPortal\u0027).first().json;\nconst db = $input.first().json;\n\n// Garante proteção contra retorno vazio do banco e diferencia cliente novo/cadastrado\nconst dbData = db || {};\nconst hasCliente = !!(dbData.nome_completo);\n\nconst nomeFinal = dbData.nome_completo || norm.nome_portal || \u0027Cliente\u0027;\nconst emailFinal = dbData.email || norm.email_portal || \u0027\u0027;\nconst telFinal = (dbData.celular || norm.telefone_portal || \u0027\u0027).toString().replace(/\\D/g, \u0027\u0027);\nconst cpfFinal = norm.cpf_portal || (dbData.cpf ? dbData.cpf.replace(/\\D/g, \u0027\u0027) : \u0027\u0027);\n\nconst apolicesRaw = Array.isArray(dbData.apolices_ativas) ? dbData.apolices_ativas : [];\nconst resumo_apolices = apolicesRaw.map(ap =\u003e ({\n    seguradora: ap.seguradora || \u0027N/A\u0027,\n    tipo: ap.ramo || \u0027N/A\u0027,\n    status: ap.status_apolice || \u0027ATIVA\u0027,\n    apolice: ap.numero_apolice || \u0027N/A\u0027,\n    vencimento: ap.vigencia_fim || \u0027N/A\u0027,\n    placa: ap.placa || \u0027N/A\u0027\n}));\n\nreturn [{\n    json: {\n        pergunta_cliente: norm.pergunta_cliente,\n        session_key: norm.session_key,\n        origem: \u0027PORTAL_WEB\u0027,\n        contexto: {\n            nome: nomeFinal,\n            cpf_real: cpfFinal,\n            cpf_exibicao: cpfFinal ? \u0027***.***.***-\u0027 + cpfFinal.slice(-2) : \u0027Nao informado\u0027,\n            telefone: telFinal,\n            email_cadastrado: emailFinal,\n            token_validado: \u0027SIM\u0027,\n            cadastrado: hasCliente,\n            origem: \u0027PORTAL_WEB\u0027,\n            tipo_cliente: hasCliente ? \u0027CADASTRADO\u0027 : \u0027NOVO\u0027,\n            resumo_apolices: resumo_apolices\n        }\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        720,
        6800
      ],
      "id": "aab12345-0004-4000-b000-000000000004",
      "name": "MontarContextoPortal"
    },
    {
      "parameters": {
        "jsCode": "const out = $input.first().json;\nconst texto = out.output || out.text || out.response || \u0027Nao consegui gerar uma resposta. Tente novamente.\u0027;\nreturn [{ json: { response: texto } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        6800
      ],
      "id": "aab12345-0008-4000-b000-000000000008",
      "name": "FormatarRespostaPortal"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "portal-origin-check-001",
              "leftValue": "={{ (() => { try { return $(\u0027MontarContextoPortal\u0027).first().json.origem; } catch(e) { return \u0027WHATSAPP\u0027; } })() }}",
              "rightValue": "PORTAL_WEB",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        960,
        6800
      ],
      "id": "aab12345-0009-4000-b000-000000000009",
      "name": "IF_Portal_Origem"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "NormalizeInbound",
            "type": "main",
            "index": 0
          },
          {
            "node": "Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados": {
      "main": [
        [
          {
            "node": "Consultar WAHA Direto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Seen": {
      "main": [
        [
          {
            "node": "Start Typing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start Typing": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "FiltrarResposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar WAHA Direto": {
      "main": [
        [
          {
            "node": "Limpar Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Telefone": {
      "main": [
        [
          {
            "node": "MergeDados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca_Cliente": {
      "main": [
        [
          {
            "node": "Buscar_Sessao_Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agrupar_Texto": {
      "main": [
        [
          {
            "node": "Atualizar_Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar_Buffer": {
      "main": [
        [
          {
            "node": "Espera_3_Segundos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Espera_3_Segundos": {
      "main": [
        [
          {
            "node": "Check_Pos_Espera",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check_Pos_Espera": {
      "main": [
        [
          {
            "node": "Filtro_Ultima_Execucao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro_Ultima_Execucao": {
      "main": [
        [
          {
            "node": "Limpar_Buffer_Pos_Execucao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recuperar_Buffer": {
      "main": [
        [
          {
            "node": "Agrupar_Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CheckOrigem": {
      "main": [
        [
          {
            "node": "Recuperar_Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchOrigem": {
      "main": [
        [
          {
            "node": "Busca_Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Busca_Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Busca_Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar_Sessao_Existente": {
      "main": [
        [
          {
            "node": "SwitchMidia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchMidia": {
      "main": [
        [
          {
            "node": "DownloadMidia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ImageDownload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ConsolidarMensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DownloadMidia": {
      "main": [
        [
          {
            "node": "IA_Processar_Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ImageDownload": {
      "main": [
        [
          {
            "node": "IA_Processar_Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DefinirContextoAI": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA_Processar_Audio": {
      "main": [
        [
          {
            "node": "ConsolidarMensagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ConsolidarMensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IA_Processar_Imagem": {
      "main": [
        [
          {
            "node": "ConsolidarMensagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ConsolidarMensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ConsolidarMensagem": {
      "main": [
        [
          {
            "node": "TratamentoErroMidia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TratamentoErroMidia": {
      "main": [
        [],
        [
          {
            "node": "DefinirContextoAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "PostgresChatMemory": {
      "ai_memory": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "QueryPostgresClientes": {
      "ai_tool": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "MergeDados": {
      "main": [
        [
          {
            "node": "FinalizeChatId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NormalizeInbound": {
      "main": [
        [
          {
            "node": "MergeDados",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Padronizar Output": {
      "main": [
        [
          {
            "node": "Send Seen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FunilRespostas": {
      "main": [
        [
          {
            "node": "IF_Portal_Origem",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar_Registro_Cliente_Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FiltrarResposta": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BrokerIA_Master": {
      "main": [
        [
          {
            "node": "FunilRespostas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check_Cliente_Novo": {
      "main": [
        [
          {
            "node": "Preparar_Registro_Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge_Registro",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Preparar_Registro_Cliente": {
      "main": [
        [
          {
            "node": "Verificar_Registro_Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar_Registro_Existente": {
      "main": [
        [
          {
            "node": "Switch_Registro_Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_Registro_Existe": {
      "main": [
        [
          {
            "node": "Inserir_Novo_Registro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Atualizar_Registro_Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir_Novo_Registro": {
      "main": [
        [
          {
            "node": "Merge_Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar_Registro_Existente": {
      "main": [
        [
          {
            "node": "Merge_Registro",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge_Registro": {
      "main": [
        [
          {
            "node": "Preparar_Input_Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "EspecialistaRegistroCotacao": {
      "ai_tool": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Preparar_Registro_Cliente_Existente": {
      "main": [
        [
          {
            "node": "Registrar_Interacao",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NormalizarEntrada": {
      "main": [
        [
          {
            "node": "Check_Cliente_Novo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FinalizeChatId": {
      "main": [
        [
          {
            "node": "CheckOrigem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar_Input_Agent": {
      "main": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar_Buffer_Pos_Execucao": {
      "main": [
        [
          {
            "node": "SwitchOrigem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "IF-Validado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "NormalizarEntrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "http": {
      "main": [
        [
          {
            "node": "Avisa Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF-Validado": {
      "main": [
        [
          {
            "node": "NormalizarEntrada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "http",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WebhookPortal": {
      "main": [
        [
          {
            "node": "NormalizarPortal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "NormalizarPortal": {
      "main": [
        [
          {
            "node": "BuscaClientePortal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BuscaClientePortal": {
      "main": [
        [
          {
            "node": "MontarContextoPortal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MontarContextoPortal": {
      "main": [
        [
          {
            "node": "BrokerIA_Master",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Portal_Origem": {
      "main": [
        [
          {
            "node": "FormatarRespostaPortal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Padronizar Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FormatarRespostaPortal": {
      "main": []
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "bb616334-e869-44e6-bb8e-a34d49572131",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6d0cb3eea1c119e43144d997ea344d5015b9ba9f4a6acb5364cecf80271874e3"
  },
  "id": "6ub3s1KYVUm42odIKeQ9M",
  "tags": []
}