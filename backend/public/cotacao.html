<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker IA | Solicitar Cotação</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <!-- Decorative background elements -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <main class="main-container">
        <div class="login-card" style="max-width: 650px;">
            <div class="logo-section">
                <h1>Solicitar Cotação</h1>
                <p>Escolha o tipo de serviço e preencha os detalhes para sua proposta.</p>
            </div>

            <!-- Seletor de Tipo de Cotação -->
            <div class="channel-options" style="margin-bottom: 2rem;">
                <label class="channel-card">
                    <input type="radio" name="tipo_cotacao_selector" value="NOVA" checked>
                    <i class="fas fa-plus-circle"></i>
                    <div class="channel-info">
                        <span class="channel-name">Nova Cotação</span>
                        <span class="channel-detail">Quero contratar um novo seguro</span>
                    </div>
                </label>
                <label class="channel-card">
                    <input type="radio" name="tipo_cotacao_selector" value="RENOVACAO">
                    <i class="fas fa-sync-alt"></i>
                    <div class="channel-info">
                        <span class="channel-name">Renovação</span>
                        <span class="channel-detail">Já tenho seguro e quero renovar</span>
                    </div>
                </label>
            </div>

            <div id="client-check" class="form-group"
                style="display: none; background: rgba(16, 185, 129, 0.05); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--primary-glow); margin-bottom: 2rem;">
                <p style="font-size: 0.9rem; margin-bottom: 1rem; color: #fff;">Você já é nosso cliente?</p>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn-login" style="margin:0; flex:1;"
                        onclick="handleIsClient(true)">Sim, sou cliente</button>
                    <button type="button" class="btn-login" style="margin:0; flex:1; background: rgba(255,255,255,0.1);"
                        onclick="handleIsClient(false)">Não, ainda não</button>
                </div>
            </div>

            <form id="quoteForm">
                <!-- Identificação Básica -->
                <input type="hidden" name="tipo_cotacao" id="tipo_cotacao" value="NOVA">

                <div class="form-group">
                    <label for="nome">Nome Completo</label>
                    <div class="input-wrapper">
                        <input type="text" id="nome" name="nome" class="premium-input" placeholder="Seu nome" required>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="telefone">WhatsApp / Telefone</label>
                        <div class="input-wrapper">
                            <input type="tel" id="telefone" name="telefone" class="premium-input"
                                placeholder="(XX) XXXXX-XXXX" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cpf">CPF</label>
                        <div class="input-wrapper">
                            <input type="text" id="cpf" name="cpf" class="premium-input" placeholder="000.000.000-00"
                                required>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="email">E-mail</label>
                    <div class="input-wrapper">
                        <input type="email" id="email" name="email" class="premium-input" placeholder="seu@email.com"
                            required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="categoria_seguro">O que deseja segurar?</label>
                    <div class="input-wrapper">
                        <select id="categoria_seguro" name="categoria_seguro" class="premium-input" required>
                            <option value="" disabled selected>Carregando categorias...</option>
                        </select>
                    </div>
                </div>

                <!-- Campos Dinâmicos Detalhados -->
                <div id="dynamicFields">
                    <!-- AUTOMÓVEL DETALHADO -->
                    <div class="dynamic-group" id="fields-auto" style="display: none;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin: 1.5rem 0 1rem;">Dados do Veículo</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Placa ou Chassi</label>
                                <input type="text" name="veiculo_identificacao" class="premium-input"
                                    placeholder="ABC-1234">
                            </div>
                            <div class="form-group">
                                <label>Ano (Fab/Modelo)</label>
                                <input type="text" name="veiculo_ano" class="premium-input" placeholder="2024/2025">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Marca</label>
                                <select id="veiculo_marca" name="veiculo_marca" class="premium-input">
                                    <option value="">Selecione a Marca</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Modelo</label>
                                <select id="veiculo_modelo" name="veiculo_modelo" class="premium-input" disabled>
                                    <option value="">Selecione a Marca primeiro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Dispositivos de Segurança (Alarme, Rastreador, etc.)</label>
                            <input type="text" name="veiculo_seguranca" class="premium-input" placeholder="Nenhum">
                        </div>

                        <h3 style="font-size: 1rem; color: var(--primary); margin: 1.5rem 0 1rem;">Uso e Perfil</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Uso Principal</label>
                                <select name="veiculo_uso" class="premium-input">
                                    <option value="lazer">Lazer / Ida ao Trabalho</option>
                                    <option value="profissional">Profissional (App/Entregas)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>CEP de Pernoite</label>
                                <input type="text" name="veiculo_cep" class="premium-input" placeholder="00000-000">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Garagem em Casa?</label>
                                <select name="veiculo_garagem" class="premium-input">
                                    <option value="sim">Sim, fechada</option>
                                    <option value="nao">Não, na rua</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>KM Diária Estimada</label>
                                <input type="number" name="veiculo_km_diaria" class="premium-input"
                                    placeholder="ex: 20">
                            </div>
                        </div>
                    </div>

                    <!-- RESIDENCIAL DETALHADO -->
                    <div class="dynamic-group" id="fields-residencial" style="display: none;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin: 1.5rem 0 1rem;">Dados do Imóvel</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>CEP do Imóvel</label>
                                <input type="text" name="res_cep" class="premium-input" placeholder="00000-000">
                            </div>
                            <div class="form-group">
                                <label>Tipo de Imóvel</label>
                                <select name="res_tipo" class="premium-input">
                                    <option value="casa">Casa</option>
                                    <option value="apartamento">Apartamento</option>
                                    <option value="sobrado">Sobrado</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Estrutura</label>
                                <select name="res_construcao" class="premium-input">
                                    <option value="alvenaria">Alvenaria</option>
                                    <option value="madeira">Madeira</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Finalidade</label>
                                <select name="res_finalidade" class="premium-input">
                                    <option value="habitual">Morada Habitual</option>
                                    <option value="veraneio">Veraneio</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Valor Estimado de Reconstrução (R$)</label>
                            <input type="number" name="res_valor_reconstrucao" class="premium-input"
                                placeholder="ex: 300000">
                        </div>
                    </div>

                    <!-- VIDA DETALHADO -->
                    <div class="dynamic-group" id="fields-vida" style="display: none;">
                        <h3 style="font-size: 1rem; color: var(--primary); margin: 1.5rem 0 1rem;">Perfil de Saúde</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Data de Nascimento</label>
                                <input type="date" name="vida_nascimento" class="premium-input">
                            </div>
                            <div class="form-group">
                                <label>Peso (kg)</label>
                                <input type="number" name="vida_peso" class="premium-input" placeholder="ex: 75">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label>Altura (cm)</label>
                                <input type="number" name="vida_altura" class="premium-input" placeholder="ex: 175">
                            </div>
                            <div class="form-group">
                                <label>Fumante?</label>
                                <select name="vida_fumante" class="premium-input">
                                    <option value="nao">Não</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Profissão / Ocupação</label>
                            <input type="text" name="vida_profissao" class="premium-input"
                                placeholder="Sua ocupação principal">
                        </div>
                    </div>
                </div>

                <!-- Campo de Renovação (Condicional) -->
                <div id="renewal-fields"
                    style="display: none; border-top: 1px solid rgba(255,255,255,0.05); margin-top: 2rem; padding-top: 1rem;">
                    <h3 style="font-size: 1rem; color: var(--secondary); margin-bottom: 1rem;">Detalhes da Renovação
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Seguradora Atual</label>
                            <input type="text" name="renovacao_seguradora" class="premium-input"
                                placeholder="Ex: Porto, Azul...">
                        </div>
                        <div class="form-group">
                            <label>Classe de Bônus (0 a 10)</label>
                            <input type="number" name="renovacao_bonus" class="premium-input" placeholder="ex: 5">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="observacoes">Observações ou Coberturas Adicionais</label>
                    <div class="input-wrapper">
                        <textarea id="observacoes" name="observacoes" class="premium-input" rows="3"
                            placeholder="Algo mais que precisamos saber?"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-login" id="submitBtn">Solicitar Orçamento Agora</button>
            </form>

            <div class="footer-links">
                <a href="index.html"><i class="fas fa-arrow-left"></i> Voltar para Home</a>
            </div>
        </div>

        <!-- Modal de Login 2FA para Clientes -->
        <div id="loginModal" class="modal"
            style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); align-items: center; justify-content: center;">
            <div class="login-card" style="width: 100%; max-width: 400px; margin: 0 20px; position: relative;">
                <button type="button" onclick="closeLoginModal()"
                    style="position: absolute; right: 20px; top: 20px; background: none; border: none; color: #64748b; cursor: pointer; font-size: 1.2rem;">
                    <i class="fas fa-times"></i>
                </button>

                <div class="logo-section" style="margin-bottom: 2rem;">
                    <h2 id="loginModalTitle" style="font-family: 'Outfit'; color: #fff;">Validar Acesso</h2>
                    <p id="loginModalDesc">Identifique-se para carregar seus dados.</p>
                </div>

                <div id="modalStep1">
                    <div class="form-group">
                        <label>CPF ou CNPJ</label>
                        <input type="text" id="modalIdentifier" class="premium-input" placeholder="000.000.000-00">
                    </div>
                    <button type="button" class="btn-login" id="btnModalStep1" onclick="handleModalStep1()">Verificar
                        Identidade</button>
                </div>

                <div id="modalStep2" style="display: none;">
                    <label
                        style="display: block; margin-bottom: 1rem; color: #94a3b8; font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Como
                        deseja receber o código?</label>
                    <div class="channel-options" style="flex-direction: column; gap:10px;">
                        <label class="channel-card" style="padding: 1rem;">
                            <input type="radio" name="modal_channel" value="whatsapp" checked>
                            <i class="fab fa-whatsapp"></i>
                            <div class="channel-info">
                                <span class="channel-name">WhatsApp</span>
                                <span class="channel-detail" id="modalMaskedPhone"></span>
                            </div>
                        </label>
                        <label class="channel-card" style="padding: 1rem;">
                            <input type="radio" name="modal_channel" value="email">
                            <i class="fas fa-envelope"></i>
                            <div class="channel-info">
                                <span class="channel-name">E-mail</span>
                                <span class="channel-detail" id="modalMaskedEmail"></span>
                            </div>
                        </label>
                    </div>
                    <button type="button" class="btn-login" id="btnModalStep2" onclick="handleModalStep2()"
                        style="margin-top: 1.5rem;">Receber Código</button>
                </div>

                <div id="modalStep3" style="display: none;">
                    <div class="form-group">
                        <label>Token de Segurança</label>
                        <input type="text" id="modalToken" class="premium-input" placeholder="000000" maxlength="6"
                            style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5em;">
                    </div>
                    <button type="button" class="btn-login" id="btnModalStep3" onclick="handleModalStep3()">Validar
                        Código</button>
                    <button type="button" onclick="resetModalToStep2()"
                        style="background:none; border:none; color: var(--primary); font-size: 0.8rem; margin-top: 1rem; width:100%; cursor:pointer;">Não
                        recebi o código</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- Elementos DOM ---
        const categoriaSelect = document.getElementById('categoria_seguro');
        const dynamicGroups = document.querySelectorAll('.dynamic-group');
        const veiculoMarcaSelect = document.getElementById('veiculo_marca');
        const veiculoModeloSelect = document.getElementById('veiculo_modelo');
        const renewalFields = document.getElementById('renewal-fields');
        const clientCheck = document.getElementById('client-check');
        const tipoCotacaoInput = document.getElementById('tipo_cotacao');
        const quoteForm = document.getElementById('quoteForm');

        // --- Estado Global ---
        let insuranceStructure = [];

        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInsuranceData();
            setupQuotationTypeSelectors();
            checkRenewalData();
        });

        function checkRenewalData() {
            const raw = localStorage.getItem('renewal_data');
            if (!raw) return;

            try {
                const data = JSON.parse(raw);
                localStorage.removeItem('renewal_data'); // Limpa após ler

                // Marca como Renovação
                const renovacaoRadio = document.querySelector('input[value="RENOVACAO"]');
                if (renovacaoRadio) {
                    renovacaoRadio.checked = true;
                    // Dispara o evento de mudança manualmente para mostrar os campos
                    renovacaoRadio.dispatchEvent(new Event('change'));
                }

                // Preenche campos comuns
                if (data.seguradora) {
                    const segInput = document.querySelector('input[name="renovacao_seguradora"]');
                    if (segInput) segInput.value = data.seguradora;
                }
                if (data.bonus) {
                    const bonusInput = document.querySelector('input[name="renovacao_bonus"]');
                    if (bonusInput) bonusInput.value = data.bonus;
                }
                if (data.placa) {
                    const placaInput = document.querySelector('input[name="veiculo_identificacao"]');
                    if (placaInput) placaInput.value = data.placa;
                }
                if (data.chassi) {
                    const chassiInput = document.querySelector('input[name="veiculo_identificacao"]');
                    if (chassiInput && !chassiInput.value) chassiInput.value = data.chassi;
                }

                // Observação automática
                const obs = document.getElementById('observacoes');
                if (obs) obs.value = `Solicitação de renovação para apólice nº ${data.numero_apolice}. Vigência até ${new Date(data.vigencia_fim).toLocaleDateString('pt-BR')}.`;

                alert('Dados da sua apólice atual foram carregados com sucesso para facilitar a renovação.');

            } catch (e) { console.error('Erro ao carregar dados de renovação:', e); }
        }

        function setupQuotationTypeSelectors() {
            const selectors = document.querySelectorAll('input[name="tipo_cotacao_selector"]');
            selectors.forEach(s => {
                s.addEventListener('change', (e) => {
                    const val = e.target.value;
                    tipoCotacaoInput.value = val;

                    if (val === 'RENOVACAO') {
                        renewalFields.style.display = 'block';
                        clientCheck.style.display = 'block';
                    } else {
                        renewalFields.style.display = 'none';
                        clientCheck.style.display = 'none';
                    }
                });
            });
        }

        function handleIsClient(isClient) {
            if (isClient) {
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('modalStep1').style.display = 'block';
                document.getElementById('modalStep2').style.display = 'none';
                document.getElementById('modalStep3').style.display = 'none';
                document.getElementById('modalIdentifier').focus();
            } else {
                clientCheck.style.display = 'none';
                alert('Por favor, preencha o formulário abaixo com seus dados para iniciarmos seu cadastro.');
            }
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // --- Lógica do Modal 2FA ---
        const ORG_SLUG = 'corretora-demo';
        const API_URL = 'https://brokeria-api-brokeriaweb.cx0m9g.easypanel.host/api';
        let modalClientId = null;

        async function handleModalStep1() {
            const identifier = document.getElementById('modalIdentifier').value;
            const btn = document.getElementById('btnModalStep1');
            if (!identifier) return alert('Por favor, informe seu CPF ou CNPJ.');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando...';

            try {
                const res = await fetch(`${API_URL}/auth/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, org_slug: ORG_SLUG })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao identificar segurado');

                modalClientId = data.client_id;
                document.getElementById('modalMaskedPhone').textContent = data.masked_phone;
                document.getElementById('modalMaskedEmail').textContent = data.masked_email;

                document.getElementById('modalStep1').style.display = 'none';
                document.getElementById('modalStep2').style.display = 'block';
                document.getElementById('loginModalDesc').textContent = 'Escolha como receber seu código.';
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Verificar Identidade';
            }
        }

        async function handleModalStep2() {
            const channel = document.querySelector('input[name="modal_channel"]:checked').value;
            const identifier = document.getElementById('modalIdentifier').value;
            const btn = document.getElementById('btnModalStep2');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-paper-plane fa-spin"></i> Enviando...';

            try {
                const res = await fetch(`${API_URL}/auth/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ identifier, org_slug: ORG_SLUG, channel })
                });

                if (!res.ok) throw new Error('Erro ao enviar código.');

                document.getElementById('modalStep2').style.display = 'none';
                document.getElementById('modalStep3').style.display = 'block';
                document.getElementById('loginModalDesc').textContent = 'Digite o código de 6 dígitos que enviamos.';
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Receber Código';
            }
        }

        async function handleModalStep3() {
            const token = document.getElementById('modalToken').value;
            const btn = document.getElementById('btnModalStep3');
            if (token.length < 6) return alert('O código deve ter 6 dígitos.');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-shield-alt fa-spin"></i> Validando...';

            try {
                const res = await fetch(`${API_URL}/auth/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: modalClientId, token })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Código inválido.');

                // Sucesso! Preenche o formulário e fecha o modal
                localStorage.setItem('broker_ia_token', data.token);
                localStorage.setItem('broker_ia_user', JSON.stringify(data.user));

                // Preencher campos do form de cotação
                document.getElementById('nome').value = data.user.nome;
                document.getElementById('cpf').value = data.user.cpf_cnpj;
                if (data.user.email) document.getElementById('email').value = data.user.email;

                closeLoginModal();
                clientCheck.style.display = 'none';
                alert(`Olá ${data.user.nome.split(' ')[0]}, reconhecemos seu cadastro. Seus dados básicos foram preenchidos!`);

                // Se o intuito for renovação, o formulário já está configurado para tal
            } catch (err) {
                alert(err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Validar Código';
            }
        }

        function resetModalToStep2() {
            document.getElementById('modalStep3').style.display = 'none';
            document.getElementById('modalStep2').style.display = 'block';
        }

        async function loadInsuranceData() {
            try {
                const res = await fetch('/api/seguros/estrutura');
                insuranceStructure = await res.json();

                categoriaSelect.innerHTML = '<option value="" disabled selected>Selecione uma categoria</option>';
                insuranceStructure.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.categoria_id;
                    opt.textContent = cat.categoria_nome;
                    categoriaSelect.appendChild(opt);
                });
            } catch (error) {
                console.error('Erro ao carregar seguros:', error);
                categoriaSelect.innerHTML = `<option value="" disabled selected>Falha ao carregar</option>`;
            }
        }

        // --- Evento: Mudança de Categoria ---
        categoriaSelect.addEventListener('change', function () {
            const catId = this.value;
            const category = insuranceStructure.find(c => c.categoria_id == catId);
            if (!category) return;

            hideAllDynamicFields();
            const catName = category.categoria_nome.toLowerCase();

            // Lógica de separação solicitada: Automóvel vs Transporte vs Residencial vs Vida
            if (catName.includes('automóvel') || catName.includes('veículo')) {
                showDynamicGroup('fields-auto');
                loadVeiculoMarcas('CARRO');
            } else if (catName.includes('transporte')) {
                showDynamicGroup('fields-auto'); // Usa base de auto mas podemos customizar no futuro
                loadVeiculoMarcas('CAMINHAO');
            } else if (catName.includes('residencial') || catName.includes('patrimoniais')) {
                showDynamicGroup('fields-residencial');
            } else if (catName.includes('vida') || catName.includes('pessoas')) {
                showDynamicGroup('fields-vida');
            }
        });

        if (veiculoMarcaSelect) {
            veiculoMarcaSelect.addEventListener('change', function () {
                const marcaId = this.value;
                if (marcaId) loadVeiculoModelos(marcaId);
            });
        }

        async function loadVeiculoMarcas(tipo = 'CARRO') {
            try {
                veiculoMarcaSelect.innerHTML = '<option value="" disabled selected>Carregando...</option>';
                const res = await fetch(`/api/seguros/veiculos/marcas?categoria=${tipo}`);
                const marcas = await res.json();

                veiculoMarcaSelect.innerHTML = '<option value="" disabled selected>Selecione a Marca</option>';
                marcas.forEach(marca => {
                    const opt = document.createElement('option');
                    opt.value = marca.id;
                    opt.textContent = marca.nome;
                    veiculoMarcaSelect.appendChild(opt);
                });
            } catch (error) { console.error(error); }
        }

        async function loadVeiculoModelos(parentId) {
            try {
                veiculoModeloSelect.disabled = true;
                veiculoModeloSelect.innerHTML = '<option value="" disabled selected>Carregando...</option>';
                const res = await fetch(`/api/seguros/veiculos/modelos/${parentId}`);
                const modelos = await res.json();

                veiculoModeloSelect.innerHTML = '<option value="" disabled selected>Selecione o Modelo</option>';
                modelos.forEach(mod => {
                    const opt = document.createElement('option');
                    opt.value = mod.nome;
                    opt.textContent = mod.nome;
                    veiculoModeloSelect.appendChild(opt);
                });
                veiculoModeloSelect.disabled = false;
            } catch (error) { console.error(error); }
        }

        function hideAllDynamicFields() {
            dynamicGroups.forEach(group => group.style.display = 'none');
        }

        function showDynamicGroup(id) {
            const group = document.getElementById(id);
            if (group) group.style.display = 'block';
        }

        quoteForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;

            btn.innerText = 'Enviando...';
            btn.disabled = true;

            try {
                const formData = new FormData(e.target);

                // Enriquecimento de labels
                if (categoriaSelect.selectedOptions[0])
                    formData.append('categoria_nome', categoriaSelect.selectedOptions[0].text);
                if (veiculoMarcaSelect && veiculoMarcaSelect.selectedOptions[0])
                    formData.append('veiculo_marca_nome', veiculoMarcaSelect.selectedOptions[0].text);

                const data = Object.fromEntries(formData.entries());

                const response = await fetch('/api/seguros/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('✅ Solicitação de ' + data.tipo_cotacao + ' recebida com sucesso!');
                    window.location.href = 'index.html';
                } else {
                    const resJson = await response.json();
                    throw new Error(resJson.error || 'Erro ao enviar');
                }
            } catch (error) {
                alert('❌ Erro: ' + error.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>